const fs = require('fs');
const path = require('path');

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ¾Ğ½ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ°Ğ¼ĞµĞ½
let transcriptions = {};
try {
    const transcriptionsPath = path.join(__dirname, 'transcriptions.json');
    if (fs.existsSync(transcriptionsPath)) {
        transcriptions = JSON.parse(fs.readFileSync(transcriptionsPath, 'utf8'));
        console.log('âœ… Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ñ„Ğ¾Ğ½ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ°Ğ¼ĞµĞ½:', Object.keys(transcriptions).length);
    }
} catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ transcriptions.json:', error);
}

const botBehavior = {
    // ============================================
    // Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞ«Ğ™ ĞŸĞ ĞĞœĞŸĞ¢
    // ============================================
    systemPrompt: (context) => `
  You are the personal assistant of "Leader" company (Hebrew speaker).
  Gender: Female.

  CONTEXT:
  - Date: ${context.currentDate || '2026-01-26'}
  - Phone: ${context.userPhone || 'Unknown'}
  - Client Gender: ${context.gender || 'Unknown'}

  # ğŸš» GENDER RULES (ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ):
  1. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ» "Unknown" (Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½), Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ¿Ğ¾ Ğ³Ğ¾Ğ»Ğ¾ÑÑƒ/Ñ‚ĞµĞºÑÑ‚Ñƒ.
  2. ĞĞ°Ñ‡Ğ½Ğ¸ ĞŸĞ•Ğ Ğ’Ğ«Ğ™ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ñ Ñ‚ĞµĞ³Ğ°: [GENDER: male] Ğ¸Ğ»Ğ¸ [GENDER: female].
  3. Ğ¡Ñ‚Ñ€Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ±Ğ»ÑĞ´Ğ°Ğ¹ Ğ¸Ğ²Ñ€Ğ¸Ñ‚ÑĞºÑƒÑ Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°Ñ‚Ğ¸ĞºÑƒ (Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ğ¹ÑÑ Ğº Ğ¼ÑƒĞ¶Ñ‡Ğ¸Ğ½Ğµ Ğ² Ğ¼ÑƒĞ¶ÑĞºĞ¾Ğ¼ Ñ€Ğ¾Ğ´Ğµ, Ğº Ğ¶ĞµĞ½Ñ‰Ğ¸Ğ½Ğµ â€” Ğ² Ğ¶ĞµĞ½ÑĞºĞ¾Ğ¼).

  # ğŸ›‘ ANTI-HANGUP & ENGAGEMENT (ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ):
  1. Ğ¢Ğ•Ğ‘Ğ• Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ¿Ñ€Ğ¾Ñ‰Ğ°Ñ‚ÑŒÑÑ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€.
  2. ĞšĞĞ–Ğ”Ğ«Ğ™ Ğ¢Ğ’ĞĞ™ ĞĞ¢Ğ’Ğ•Ğ¢ Ğ”ĞĞ›Ğ–Ğ•Ğ Ğ—ĞĞšĞĞĞ§Ğ˜Ğ’ĞĞ¢Ğ¬Ğ¡Ğ¯ Ğ’ĞĞŸĞ ĞĞ¡ĞĞœ.
     - ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: "...×–×” ×¢×•×œ×” 1500 ×©×§×œ. ×”×× ×–×” ××ª××™× ×œ×š?"
     - ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: "...×©×œ×—×ª×™ ×œ×š ××ª ×”×ª××•× ×”. ×™×© ×¢×•×“ ××©×”×• ×©×ª×¨×¦×” ×œ×¨××•×ª?"
  3. Ğ•ÑĞ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ:
     - Ğ¡ĞºĞ°Ğ¶Ğ¸: "××™×Ÿ ×œ×™ ××ª ×”××™×“×¢ ×”×–×” ×›×¨×’×¢" (ĞĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸).
     - Ğ˜ Ğ¡Ğ ĞĞ—Ğ£ Ğ¡ĞŸĞ ĞĞ¡Ğ˜: "××‘×œ ××•×œ×™ ×ª×¨×¦×” ×œ×©××•×œ ×¢×œ ××©×”×• ××—×¨?" (Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑĞ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼?).

  # â›” Ğ—ĞĞŸĞ Ğ•Ğ¢Ğ«:
  1. ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ Ğ´Ğ¸ĞºÑ‚ÑƒĞ¹ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ¼ (http...).
  2. ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ½Ğ¾ÑĞ¸ "Ğ—Ğ²ĞµĞ·Ğ´Ğ¾Ñ‡ĞºĞ°" (*) Ğ¸Ğ»Ğ¸ ÑĞ¿ĞµÑ†ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹.
  3. ĞĞµ Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ñ†ĞµĞ½Ñ‹.
  4. ĞĞµ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€ÑƒĞ¹ Ğ±ĞµĞ· ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ñ Ğ½Ğ° ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹.

  5. # ğŸŒ Ğ¯Ğ—Ğ«Ğš (LANGUAGE):
   - ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞ·Ñ‹Ğº: Ğ˜Ğ’Ğ Ğ˜Ğ¢.
   - ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° Ğ Ğ£Ğ¡Ğ¡ĞšĞ˜Ğ™: Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ "××¤×©×¨ ×œ×“×‘×¨ ×‘×¨×•×¡×™×ª", "Russian", "Rusit", "Paruski" "Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ", ("×¤×¨×•×¡×§×™"), "Gavori po ruski" -> ĞĞ•ĞœĞ•Ğ”Ğ›Ğ•ĞĞĞ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº.
   - Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ -> ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼.

  # ğŸ§  SMART BEHAVIOR (ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ ĞŸĞĞ’Ğ•Ğ”Ğ•ĞĞ˜Ğ¯):
  1. â³ Ğ˜ĞĞ¢Ğ•Ğ Ğ’ĞĞ›Ğ« Ğ’Ğ Ğ•ĞœĞ•ĞĞ˜:
     - Ğ•ÑĞ»Ğ¸ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ñ… Ñ‡Ğ°ÑĞ¾Ğ² Ğ¼Ğ½Ğ¾Ğ³Ğ¾, ĞĞ• Ğ¿ĞµÑ€ĞµÑ‡Ğ¸ÑĞ»ÑĞ¹ Ğ¸Ñ… (8, 9, 10...).
     - Ğ¡ĞºĞ°Ğ¶Ğ¸: "×™×© ××§×•× ×¤× ×•×™ ×‘×™×Ÿ ×”×©×¢×•×ª 08:00 ×œ-14:00" (Ğ•ÑÑ‚ÑŒ Ğ¼ĞµÑÑ‚Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ X Ğ¸ Y).
  2. ğŸ¤ ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ ĞšĞĞĞ¡Ğ£Ğ›Ğ¬Ğ¢ĞĞ¦Ğ˜Ğ˜:
     - Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ (Ñ†ĞµĞ½Ğ°, Ñ„Ğ¾Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾).
     - ĞĞµ Ñ‚Ğ¾Ğ»ĞºĞ°Ğ¹ "Ğ—Ğ°ĞºĞ°Ğ·", Ğ¿Ğ¾ĞºĞ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹.
  3. ğŸ¢ Ğ”Ğ›Ğ¯ Ğ¢Ğ•Ğ ĞœĞ˜ĞĞĞ›ĞĞ’:
     - ĞĞ• Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ğ¹ Ğ¿Ñ€Ğ¸ĞµÑ…Ğ°Ñ‚ÑŒ Ğ² Ğ¾Ñ„Ğ¸Ñ, Ğ¿Ğ¾ĞºĞ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ°Ğ¼ Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ "ĞŸÑ€Ğ¸Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ".
  4. ğŸ—£ï¸ Ğ§Ğ˜Ğ¡Ğ¢Ğ«Ğ• Ğ˜ĞœĞ•ĞĞ:
     - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ²Ñ€Ğ¸Ñ‚ÑĞºĞ¸Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ…Ñ‚ ("×¡×¤×™× ×ª ×§×™×¤×•×Ÿ"), Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞ¹ Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸.

  5.  # ğŸ“¸ Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ ĞœĞ•Ğ”Ğ˜Ğ (ĞŸĞ ĞĞ¤Ğ•Ğ¡Ğ¡Ğ˜ĞĞĞĞ›Ğ¬ĞĞ«Ğ™ ĞŸĞĞ”Ğ¥ĞĞ”):
  Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾:
  1. Ğ’Ñ‹Ğ·Ğ¾Ğ²Ğ¸ 'send_whatsapp_message' Ñ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹.
  2. ğŸ—£ï¸ Ğ¡ĞšĞĞ–Ğ˜ Ğ“ĞĞ›ĞĞ¡ĞĞœ (ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ): 
     "×‘×˜×—, ×©×œ×—×ª×™ ×œ×š ×œ×•×•×˜×¡××¤. ×× ×œ× ×§×™×‘×œ×ª, ×©×œ×—×ª×™ ×œ×š ×’× SMS. ×ª×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨ ×‘-SMS ×›×“×™ ×œ××©×¨ ×§×‘×œ×ª ×ª××•× ×•×ª."
     (ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ² WhatsApp. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ â€” Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° SMS. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° ÑÑÑ‹Ğ»ĞºÑƒ Ğ² SMS, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾).

 # ğŸ“¢ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ˜ (Ğ”Ğ›Ğ¯ Ğ›Ğ®Ğ‘ĞĞ“Ğ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯):
  ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ€Ğ°Ğ·, ĞºĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ² WhatsApp (Ñ„Ğ¾Ñ‚Ğ¾, Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·), Ñ‚Ñ‹ ĞĞ‘Ğ¯Ğ—ĞĞĞ ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ¼:
  "×©×œ×—×ª×™ ×œ×š ×œ×•×•×˜×¡××¤. ×× ×œ× ×§×™×‘×œ×ª, ×©×œ×—×ª×™ ×œ×š ×›×¨×’×¢ SMS ×¢× ×§×™×©×•×¨. ×œ×—×™×¦×” ××—×ª ×¢×œ ×”×§×™×©×•×¨ ×•×”×”×•×“×¢×” ×ª×•×¤×™×¢ ××¦×œ×š."
  (Ğ¯ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ² Ğ’Ğ°Ñ‚ÑĞ°Ğ¿. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¾ - Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ¡ĞœĞ¡ Ñ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ½ĞµÑ‘, Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ).    

  # ğŸ“‹ Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™ Ğ”Ğ˜ĞĞ›ĞĞ“Ğ (Ğ¯Ğ¥Ğ¢Ğ«):
  
  Ğ¨ĞĞ“ 1. Ğ’Ğ«Ğ¯Ğ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞĞ¢Ğ Ğ•Ğ‘ĞĞĞ¡Ğ¢Ğ•Ğ™ (Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸ ÑÑ‚Ğ¾ Ğ² Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ!):
     - "×‘××™×–×• ×¢×™×¨ - ×”×¨×¦×œ×™×” ××• ×—×™×¤×”?"
     - "×œ×›××” ××©×ª×ª×¤×™×?" (Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ»ÑĞ´ĞµĞ¹?) - *ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾!*
     - "×œ××™×–×” ×ª××¨×™×š?"
  
  Ğ¨ĞĞ“ 2. ĞŸĞ Ğ•Ğ—Ğ•ĞĞ¢ĞĞ¦Ğ˜Ğ¯:
     - ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ (Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞ¹ Ğ¿Ğ¾ Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸!).
     - Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑÑ‚ Ñ„Ğ¾Ñ‚Ğ¾ -> Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ 'send_whatsapp_message' (Ğ²ÑÑ‚Ğ°Ğ²ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ!).

  Ğ¨ĞĞ“ 3. Ğ—ĞĞšĞ Ğ«Ğ¢Ğ˜Ğ• Ğ¡Ğ”Ğ•Ğ›ĞšĞ˜ (ĞĞŸĞ›ĞĞ¢Ğ):
     - Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ "Ğ¥Ğ¾Ñ‡Ñƒ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ" Ğ¸Ğ»Ğ¸ "ĞšĞ°Ğº Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ?":
       A. ğŸ—£ï¸ ĞĞ‘ĞªĞ¯Ğ¡ĞĞ˜ Ğ“ĞĞ›ĞĞ¡ĞĞœ: 
          "×ª×”×œ×™×š ×”×”×–×× ×” ×”×•× ×¤×©×•×˜: ×× ×—× ×• ××‘×§×©×™× ××§×“××” ×©×œ 500 ×©×§×œ×™× ×œ×©×¨×™×™×Ÿ ××ª ×”×ª××¨×™×š. ×”×™×ª×¨×” ×‘×™×•× ×”×”×¤×œ×’×”."
       B. Ğ¡ĞŸĞ ĞĞ¡Ğ˜: "×œ×©×œ×•×— ×œ×š ××ª ×”×¤×¨×˜×™× ×”××œ×• ×œ×•×•××˜×¡××¤?" (ĞŸÑ€Ğ¸ÑĞ»Ğ°Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ² WhatsApp?).
       C. ğŸ“± Ğ•ÑĞ»Ğ¸ "Ğ”Ğ" -> Ğ’Ñ‹Ğ·Ğ¾Ğ²Ğ¸ 'send_closing_process_info'.
       D. Ğ–Ğ´Ğ¸ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ("ĞĞº, Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚").

Ğ¨ĞĞ“ 4. ĞĞ¤ĞĞ ĞœĞ›Ğ•ĞĞ˜Ğ• (Ğ¢ĞĞ›Ğ¬ĞšĞ ĞŸĞĞ¡Ğ›Ğ• ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”Ğ•ĞĞ˜Ğ¯):
     - Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸ Ğ˜Ğ¼Ñ.
     - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾ÑÑ‚ÑŒ ('check_yacht_availability').
     - Ğ’Ñ‹Ğ·Ğ¾Ğ²Ğ¸ 'send_booking_confirmation'.
     
     - ğŸ—£ï¸ ĞŸĞĞ¡Ğ›Ğ• Ğ­Ğ¢ĞĞ“Ğ ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ¡ĞšĞĞ–Ğ˜ Ğ“ĞĞ›ĞĞ¡ĞĞœ:
       "××¦×•×™×Ÿ, ×”×”×–×× ×” ×‘×•×¦×¢×” ×‘×”×¦×œ×—×”! ×©×œ×—×ª×™ ×œ×š ××ª ×›×œ ×”×¤×¨×˜×™× ×œ×•×•×˜×¡××¤. 
        ×©×™××• ×œ×‘: ×× ×œ× ×§×™×‘×œ×ª× ×”×•×“×¢×” ×‘×•×•×˜×¡××¤, × ×©×œ×— ×œ×›× SMS ×¢× ×§×™×©×•×¨. ×× × ×œ×—×¦×• ×¢×œ×™×•."
       (ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾, Ğ·Ğ°ĞºĞ°Ğ· Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½! Ğ¯ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ² WhatsApp. Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ WhatsApp, Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° SMS ÑĞ¾ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ½ĞµÑ‘.)

     - Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ ÑĞ¿Ñ€Ğ¾ÑĞ¸: "×¢×•×“ ××©×”×•?" (Ğ•Ñ‰Ğµ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾?).
   
 # âŒ ĞĞ¢ĞœĞ•ĞĞ Ğ—ĞĞšĞĞ—Ğ:
  - Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ: Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸ "××¡×¤×¨ ×”×–×× ×”?" -> Ğ’Ñ‹Ğ·Ğ¾Ğ²Ğ¸ 'request_cancellation
  
  ğŸ’³ Ğ”Ğ›Ğ¯ Ğ¢Ğ•Ğ ĞœĞ˜ĞĞĞ›ĞĞ’:
  - Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸: "××™×–×” ×¢×¡×§ ×™×© ×œ×š?" (ĞšĞ°ĞºĞ¾Ğ¹ Ğ±Ğ¸Ğ·Ğ½ĞµÑ?).
  - Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸: "×‘××™×–×• ×¢×™×¨ ×”×¢×¡×§?".
  - ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸: Nova 55 / Modu / Nova 156.

  ---------------------------------------------
  KNOWLEDGE BASE:
  ${context.text || 'ĞĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.'}
  ---------------------------------------------
  `,

    // ============================================
    // ĞŸĞ Ğ˜Ğ’Ğ•Ğ¢Ğ¡Ğ¢Ğ’Ğ˜Ğ•
    // ============================================
    greetings: {
        initial: '×©×œ×•×, ×”×’×¢×ª× ×œ×—×‘×¨×ª ×œ×™×“×¨, ×× ×™ ×”×¢×•×–×¨×ª ×”××™×©×™×ª. ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?',
    },

    // ============================================
    // Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯
    // ============================================
    messages: {
        checking: '×¨×§ ×¨×’×¢, ×× ×™ ×‘×•×“×§×ª...',
        noSpeech: '×œ× ×©××¢×ª×™, ××¤×©×¨ ×œ×—×–×•×¨?',
        apiError: '×™×© ×ª×§×œ×” ×§×˜× ×”, × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨',
        transferring: '××¢×‘×™×¨×” ××•×ª×š ×œ× ×¦×™×’, ×”××ª×Ÿ ×¨×’×¢.',
        waitMusicUrl: 'https://mabotmusik-2585.twil.io/mb.mp3',
    },

    // ============================================
    // ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ Ğ“ĞĞ›ĞĞ¡Ğ (Ğ’ĞĞ¨Ğ˜ ĞŸĞ ĞĞ’Ğ•Ğ Ğ•ĞĞĞ«Ğ•)
    // ============================================
    voiceSettings: {
        he: {
            language: 'he-IL',
            ttsVoice: 'Google.he-IL-Standard-A',
            sttLanguage: 'iw-IL',
        },
        ru: {
            language: 'ru-RU',
            ttsVoice: 'Google.ru-RU-Wavenet-A',
            sttLanguage: 'ru-RU',
        }
    },

    gatherSettings: {
        input: 'speech',
        speechTimeout: 'auto',
        language: 'iw-IL',
    },

    geminiSettings: {
        model: 'gemini-2.0-flash',
        temperature: 0.1,
    },

    operatorSettings: {
        phoneNumber: '+972533403449',
        timeout: 20,
        callbackUrl: 'https://api.leadertechnology.shop/handle-dial-status',
    },

    textCleanupRules: {
        markdownSymbols: /[*_#`~]/g,
        punctuation: /[.,!?;:"""''()[\]{}]/g,
        multipleSpaces: /\s+/g,
        urlPattern: /https?:\/\/\S+/g,
    },

    // ============================================
    // Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
    // ============================================

    detectLanguage(text) {
        if (!text) return 'he';
        const lower = text.toLowerCase();
        const russianKeywords = ['russian', 'rusit', '×‘×¨×•×¡×™×ª', '×¨×•×¡×™×ª', '××¤×©×¨ ×œ×“×‘×¨ ×‘×¨×•×¡×™×ª','Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸', 'Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼', '×¤×¨×•×¡×§×™', '×¤××¨×•×¡×§×™', 'paruski'];
        if (/[\u0400-\u04FF]/.test(text) || russianKeywords.some(k => lower.includes(k))) return 'ru';
        return 'he';
    },

    cleanTextForTTS(text) {
        // 1. Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑÑ‹Ğ»ĞºĞ¸
        text = text.replace(this.textCleanupRules.urlPattern, '');
        // 2. Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ—Ğ’Ğ•Ğ—Ğ”ĞĞ§ĞšĞ˜
        text = text.replace(/\*/g, '');
        // 3. ĞÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼ÑƒÑĞ¾Ñ€
        text = text.replace(this.textCleanupRules.markdownSymbols, '');
        text = text.replace(/<[^>]*>/g, '');
        text = text.replace(this.textCleanupRules.multipleSpaces, ' ').trim();

        Object.keys(transcriptions).forEach(word => {
            if (text.includes(word)) {
                const replacement = transcriptions[word];
                const regex = new RegExp(word, 'g');
                text = text.replace(regex, replacement);
            }
        });
        return text;
    },

    getSystemPrompt(context, gender = null, currentDate = null, userPhone = null) {
        return this.systemPrompt({ text: context, gender: gender, currentDate: currentDate, userPhone: userPhone });
    },

    getGreeting() { return this.greetings.initial; },

    getMessage(type) {
        return this.messages[type] || this.greetings[type] || '×©×’×™××” ×‘××¢×¨×›×ª';
    },
};

module.exports = botBehavior;