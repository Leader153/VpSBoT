const { retrieveContext } = require('../rag/retriever');
const path = require('path');
const dotenv = require('dotenv');

//ะกะฟะพัะพะฑ 1. ะะฐะดะฐัั ะฒะพะฟัะพั ะฟััะผะพ ะฒ ัะตัะผะธะฝะฐะปะต (ะััััะพ)
//ะัะพััะพ ะฝะฐะฟะธัะธัะต ะฒะพะฟัะพั ะฒ ะบะฐะฒััะบะฐั ะฟะพัะปะต ะธะผะตะฝะธ ัะฐะนะปะฐ.
//ะัะธะผะตั ะดะปั ะฟัะพะฒะตัะบะธ ัะบะธะดะบะธ:
//node tests/what_bot_sees.js "ืืฉ ืืืื ืขื ืชืฉืืื ืืืืืื?"
//(ะะตัะตะฒะพะด: "ะััั ัะบะธะดะบะฐ ะฝะฐ ะพะฟะปะฐัั ะฝะฐะปะธัะฝัะผะธ?")
//ะัะธะผะตั ะดะปั ัััั:
//ะัะปะธ ะฝะต ัะพัะธัะต ะฟะธัะฐัั ะฒ ัะตัะผะธะฝะฐะปะต, ะพัะบัะพะนัะต ัะฐะนะป tests/what_bot_sees.js 
// ะธ ะธะทะผะตะฝะธัะต ัััะพะบะธ ะฒะฝัััะธ const QUESTIONS = [...].
// ะะฐัััะพะนะบะฐ ะพะบััะถะตะฝะธั
const nodeEnv = process.env.NODE_ENV || 'development';
const envPath = path.resolve(__dirname, '..', `.env.${nodeEnv}`);
if (require('fs').existsSync(envPath)) dotenv.config({ path: envPath });
else dotenv.config({ path: path.join(__dirname, '..', '.env') });

// ะงะธัะฐะตะผ ะฒะพะฟัะพั ะธะท ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ
// process.argv[2] โ ััะพ ัะพ, ััะพ ะฒั ะฝะฐะฟะธัะตัะต ะฟะพัะปะต ะธะผะตะฝะธ ัะฐะนะปะฐ
const userQuery = process.argv[2];

// ะัะปะธ ะฒะพะฟัะพั ะฝะต ะทะฐะดะฐะฝ, ะธัะฟะพะปัะทัะตะผ ัะฟะธัะพะบ ะฟะพ ัะผะพะปัะฐะฝะธั
const QUESTIONS = userQuery 
    ? [{ text: userQuery, domain: null }] // ะัะปะธ ะตััั ะฐัะณัะผะตะฝั -> ะธัะตะผ ะตะณะพ (ะดะพะผะตะฝ ะฐะฒัะพ)
    : [ 
        // ะกัะฐะฝะดะฐััะฝัะต ะฒะพะฟัะพัั (ะตัะปะธ ะทะฐะฟัััะธะปะธ ะฑะตะท ะฐัะณัะผะตะฝัะพะฒ)
        { text: "ืืฉ ืืืื ืขื ืืืืื?", domain: "Terminals" }, // ะััั ะปะธ ัะบะธะดะบะฐ ะฝะฐ ะฝะฐะปะธัะฝัะต?
        { text: "ืืื ืขืืื ืืืืื ื'ืื?", domain: "Yachts" }
      ];

async function runXray() {
    console.log("\n๐ฉป ะะะะฃะกะ ะะะะขะะะะ ะะะะซ ะะะะะซะฅ...");
    
    for (const q of QUESTIONS) {
        console.log(`\n๐ ะะะะะะก: "${q.text}"`);
        console.log(`   (ะะพะผะตะฝ: ${q.domain || 'ะะฒัะพะผะฐัะธัะตัะบะธะน'})`);
        console.log("--------------------------------------------------");

        // 1. ะะผะธัะธััะตะผ ะฟะพะธัะบ
        const docs = await retrieveContext(q.text, 3, q.domain);
        
        if (docs.length === 0) {
            console.log("โ ะะะะ ะะะะะฃะะ ะะฃะกะขะะขะฃ! (ะะธัะตะณะพ ะฝะต ะฝะฐะนะดะตะฝะพ)");
            continue;
        }

        // 2. ะะพะบะฐะทัะฒะฐะตะผ ัะตะทัะปััะฐั
        docs.forEach((doc, i) => {
            console.log(`\n๐ [ะะะะฃะะะะข ${i+1}] -----------------------`);
            console.log(doc.pageContent); // ะะพะบะฐะทัะฒะฐะตะผ ะะะกะฌ ัะตะบัั, ะบะพัะพััะน ะฒะธะดะธั ะฑะพั
            console.log("-------------------------------------------");
        });

        console.log(`\nโ ะะฐะนะดะตะฝะพ ะดะพะบัะผะตะฝัะพะฒ: ${docs.length}`);
    }
    console.log("\n๐ ะัะพะฒะตัะบะฐ ะทะฐะฒะตััะตะฝะฐ.\n");
}

runXray();

//node tests/what_bot_sees.js "ืืฉ ืืืื ืขื ืืืืื"



